---

- name: create tls directory
  become: yes
  file:
    path: "{{ vault_base }}/config/tls"
    mode: 0750
    owner: "{{ vault_docker_uid }}"
    group: "{{ vault_docker_gid }}"
    state: directory

- name: create ca directory
  become: yes
  file:
    path: "{{ vault_base }}/config/tls/ca"
    mode: 0700
    owner: root
    group: root
    state: directory

- name: generate default CSR
  become: yes
  shell: |
    cfssl print-defaults csr | \
    jq 'del(.hosts) |
      .CN = "Autogenerated CA" |
      .names[0].O="Autogen CA for Vault" |
      .names[0].ST="WI" |
      .names[0].L="Madison" |
      .key = {"algo":"rsa","size":2048}' \
    > ca-csr.json
  args:
    chdir: "{{ vault_base }}/config/tls/ca"
    creates: "{{ vault_base }}/config/tls/ca/ca-csr.json"

- name: generate private key and certs for CA
  become: yes
  shell: |
    cfssl gencert -initca ca-csr.json | \
    cfssljson -bare vault-ca
  args:
    chdir: "{{ vault_base }}/config/tls/ca"
    creates: "{{ vault_base }}/config/tls/ca/vault-ca-key.pem"

